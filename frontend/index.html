<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FocusFlow Voice Test</title>
</head>
<body>
  <h2>üéôÔ∏è Record a voice note</h2>
  <button id="record-btn">Start Recording</button>
  <button id="stop-btn" disabled>Stop</button>

  <p id="status"></p>
  <p id="feedback"></p>

  <script>
    console.log("JavaScript is loading...");

    let mediaRecorder;
    let audioChunks = [];

    const recordBtn = document.getElementById("record-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusEl = document.getElementById("status");
    const feedbackEl = document.getElementById("feedback");

    console.log("Elements found:", {recordBtn, stopBtn, statusEl, feedbackEl});

    recordBtn.addEventListener("click", async () => {
      try {
        console.log("Record button clicked!");
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        statusEl.textContent = "üéôÔ∏è Recording...";
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.addEventListener("dataavailable", e => {
          audioChunks.push(e.data);
        });
      } catch (error) {
        console.error("Error starting recording:", error);
        alert("Error starting recording: " + error.message);
      }
    });

    stopBtn.addEventListener("click", () => {
      try {
        console.log("Stop button clicked!");
        mediaRecorder.stop();
        stopBtn.disabled = true;
        recordBtn.disabled = false;
        statusEl.textContent = "‚èπÔ∏è Recording stopped.";

        mediaRecorder.addEventListener("stop", async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "voice_note.webm");
        audioChunks = [];

        statusEl.textContent = "üì§ Uploading for transcription...";

        console.log("About to send request...");

        try {
          const res = await fetch("http://127.0.0.1:5000/transcribe", {
            method: "POST",
            body: formData,
          });

          console.log("Response status:", res.status);

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();
          console.log("Response data:", data);

          // Force update the elements
          statusEl.textContent = "‚úÖ Transcribed!";
          feedbackEl.textContent = "üìù Transcribed text: " + data.transcription;

          console.log("Updated status element:", statusEl.textContent);
          console.log("Updated feedback element:", feedbackEl.textContent);

        } catch (error) {
          console.error("Error:", error);
          statusEl.textContent = "‚ùå Error occurred";
          feedbackEl.textContent = "Error: " + error.message;
        }
        });
      } catch (error) {
        console.error("Error stopping recording:", error);
        alert("Error stopping recording: " + error.message);
      }
    });
  </script>
</body>
</html>
